---
layout: post
title: "Gazebo를 이용한 ROS2 시뮬레이션"
date: 2025-12-02 20:00:00 +0900
categories: [ROS2]
tags: [ROS2, Jazzy, Gazebo]
---

이번 시간에는 카메라가 부착되어 있는 라이다 센서를 이용한 자율주행을 하는 지게차 모형을 Gazebo에서 시뮬레이션을 해보겠습니다. URDF 파일을 수정 및 추가하여 진행해보도록 하겠습니다.



### **1. URDF의 정의 및 환경 및 경로 세팅**

#### 1.1. URDF의 정의

URDF(Unified Robot Description Format)는 로봇의 물리적 형상과 기구학적 특성을 정의하는 XML 기반의 파일 포맷입니다.  ROS에서 로봇 모델을 시각화(RViz)하거나 시뮬레이션(Gazebo)하기 위해 필수적으로 사용됩니다.

- **Links (링크):** 로봇의 뼈대(Chassis, 바퀴, 센서 등)를 구성하는 강체 부분입니다. 시각적(Visual), 충돌(Collision), 관성(Inertial) 속성을 가집니다.
- **Joints (관절):** 링크와 링크를 연결하며, 회전(Continuous/Revolute)하거나 직선 운동(Prismatic) 등의 움직임을 정의합니다.



이번 실습에서는 기본 URDF에 xacro 매크로 기능을 사용하여 반복되는 코드(바퀴, 지지대 등)를 작성합니다.

#### **1.2. 환경 설정 및 경로 지정(디렉토리 생성 포함)**

Gazebo 시뮬레이션을 실행하기 위해서는 ROS 2 워크스페이스 내에 올바른 **패키지 구조**를 만들고, 작성한 파일들이 빌드 시 설치 경로(install)로 제대로 복사되도록 **경로 설정**을 해야 합니다. 아래 명령어를 터미널에 입력하여 필수 패키지를 설치합니다.

```bash
cd ~/ros2_ws/src
ros2 pkg create --build-type ament_python my_bot
```



#### **1.3. 파일 경로**

```yaml
~/ros2_ws/src/my_bot/
├── my_bot/             
├── launch/             
│   └── rsp.launch.py   # Launch 코드 저장
├── urdf/               
│   └── robot_urdf.xacro # URDF 코드 저장
├── package.xml
├── setup.cfg
└── setup.py            # setup 코드 저장
```



### **2. 실습 코드**

아래 코드는 gazebo에서 시뮬레이션 하기 위한 로봇의 `urdf`를 작성한 `robot_urdf.xacro`  및 `launch`, `setup` 코드이며 추후 수정될 수 있습니다.

#### **2.1. launch 코드**

```python
import os
from ament_index_python.packages import get_package_share_directory
from launch import LaunchDescription
from launch.actions import IncludeLaunchDescription
from launch.launch_description_sources import PythonLaunchDescriptionSource
from launch_ros.actions import Node
import xacro

def generate_launch_description():
    pkg_name = 'my_bot'
    file_subpath = 'urdf/robot_urdf.xacro' # 혹은 robot_urdf.xacro (님 파일명에 맞게)
    
    # 1. URDF 파일 변환
    xacro_file = os.path.join(get_package_share_directory(pkg_name), file_subpath)
    robot_description_raw = xacro.process_file(xacro_file).toxml()

    # 2. 신형 Gazebo 실행 (gz sim)
    gazebo = IncludeLaunchDescription(
        PythonLaunchDescriptionSource(
            os.path.join(get_package_share_directory('ros_gz_sim'), 'launch', 'gz_sim.launch.py')
        ),
        launch_arguments={'gz_args': '-r empty.sdf'}.items(), # 빈 맵 실행
    )

    # 3. 로봇 소환 (Create Node)
    spawn_entity = Node(
        package='ros_gz_sim',
        executable='create',
        arguments=[
            '-topic', 'robot_description',
            '-name', 'my_bot',
            '-z', '0.1' # 바닥에 박히지 않게 살짝 띄움
        ],
        output='screen'
    )

    # 4. 로봇 상태 퍼블리셔
    node_robot_state_publisher = Node(
        package='robot_state_publisher',
        executable='robot_state_publisher',
        output='screen',
        parameters=[{'robot_description': robot_description_raw}]
    )

    # 5. ROS-Gazebo 다리 연결 (Bridge)
    # [1] 라이다: Gazebo -> ROS
    # [2] 조종(cmd_vel): ROS -> Gazebo
    # [3] 위치(odom): Gazebo -> ROS
    bridge = Node(
        package='ros_gz_bridge',
        executable='parameter_bridge',
        arguments=[
            '/scan@sensor_msgs/msg/LaserScan@gz.msgs.LaserScan',
            '/cmd_vel@geometry_msgs/msg/Twist@gz.msgs.Twist',
            '/odom@nav_msgs/msg/Odometry@gz.msgs.Odometry'
        ],
        output='screen'
    )

    return LaunchDescription([
        gazebo,
        node_robot_state_publisher,
        spawn_entity,
        bridge
    ])
```



#### **2.2. setup 코드**

```python
from setuptools import setup
import os
from glob import glob

package_name = 'my_bot'

setup(
    name=package_name,
    version='0.0.0',
    packages=[package_name],
    data_files=[
        ('share/ament_index/resource_index/packages',
            ['resource/' + package_name]),
        ('share/' + package_name, ['package.xml']),
        
        (os.path.join('share', package_name, 'launch'), glob('launch/*.launch.py')),
        (os.path.join('share', package_name, 'urdf'), glob('urdf/*.xacro')),
    ],
    install_requires=['setuptools'],
    zip_safe=True,
    maintainer='user',
    maintainer_email='user@todo.todo',
    description='TODO: Package description',
    license='TODO: License declaration',
    tests_require=['pytest'],
    entry_points={
        'console_scripts': [
        ],
    },
)

```



#### **2.3. udf 코드**

```xml
<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="my_bot">

  <!-- [색상 팔레트] -->
  <material name="black"><color rgba="0.1 0.1 0.1 1"/></material>
  <material name="dark_grey"><color rgba="0.2 0.2 0.2 1"/></material>
  <material name="white"><color rgba="0.95 0.95 0.95 1"/></material>
  <material name="yellow"><color rgba="1 0.75 0 1"/></material>
  <material name="red"><color rgba="0.9 0.1 0.1 1"/></material>
  <material name="silver"><color rgba="0.8 0.8 0.8 1"/></material>
  <material name="gold"><color rgba="0.8 0.6 0.2 1"/></material>

  <!-- 1. 기본 좌표계 (Base Link) -->
  <link name="base_link"/>

  <!-- 2. 하부 데크 (Chassis) -->
  <joint name="chassis_joint" type="fixed">
    <parent link="base_link"/>
    <child link="chassis"/>
    <origin xyz="0 0 0.04"/>
  </joint>

  <link name="chassis">
    <visual>
      <geometry><box size="0.25 0.16 0.01"/></geometry>
      <material name="black"/>
    </visual>
    <collision>
      <geometry><box size="0.25 0.16 0.05"/></geometry>
    </collision>
    <inertial>
      <mass value="5.0"/>
      <inertia ixx="0.05" ixy="0" ixz="0" iyy="0.05" iyz="0" izz="0.05"/>
    </inertial>
  </link>
  <gazebo reference="chassis"><material>Gazebo/FlatBlack</material></gazebo>

  <!-- 3. 상부 데크 (Top Deck) -->
  <joint name="top_deck_joint" type="fixed">
    <parent link="chassis"/>
    <child link="top_deck"/>
    <origin xyz="0 0 0.06"/>
  </joint>

  <link name="top_deck">
    <visual>
      <geometry><box size="0.25 0.16 0.005"/></geometry>
      <material name="black"/>
    </visual>
    <collision>
      <geometry><box size="0.25 0.16 0.005"/></geometry>
    </collision>
    <inertial>
      <mass value="0.1"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
  </link>
  <gazebo reference="top_deck"><material>Gazebo/FlatBlack</material></gazebo>

  <!-- 지지대 (Standoffs) -->
  <xacro:macro name="standoff" params="x y">
    <joint name="standoff_${x}_${y}" type="fixed">
      <parent link="chassis"/>
      <child link="pillar_${x}_${y}"/>
      <origin xyz="${x} ${y} 0.03"/>
    </joint>
    <link name="pillar_${x}_${y}">
      <visual>
        <geometry><cylinder radius="0.003" length="0.06"/></geometry>
        <material name="gold"/>
      </visual>
    </link>
    <gazebo reference="pillar_${x}_${y}"><material>Gazebo/Gold</material></gazebo>
  </xacro:macro>
  <xacro:standoff x="0.11" y="0.07"/>
  <xacro:standoff x="0.11" y="-0.07"/>
  <xacro:standoff x="-0.11" y="0.07"/>
  <xacro:standoff x="-0.11" y="-0.07"/>

  <!-- 4. 하얀색 박스 (PC) -->
  <joint name="box_joint" type="fixed">
    <parent link="top_deck"/>
    <child link="white_box"/>
    <origin xyz="-0.02 0 0.035"/>
  </joint>

  <link name="white_box">
    <visual>
      <geometry><box size="0.12 0.10 0.07"/></geometry>
      <material name="white"/>
    </visual>
    <collision>
      <geometry><box size="0.12 0.10 0.07"/></geometry>
    </collision>
    <inertial>
      <mass value="0.5"/>
      <inertia ixx="0.01" ixy="0" ixz="0" iyy="0.01" iyz="0" izz="0.01"/>
    </inertial>
  </link>
  <gazebo reference="white_box"><material>Gazebo/White</material></gazebo>

  <!-- 5. 바퀴 (Mecanum Wheels) -->
  <xacro:macro name="wheel" params="prefix x y">
    <joint name="${prefix}_wheel_joint" type="continuous">
      <parent link="base_link"/>
      <child link="${prefix}_wheel"/>
      <origin xyz="${x} ${y} 0.04" rpy="-1.5708 0 0"/>
      <axis xyz="0 0 1"/>
    </joint>

    <link name="${prefix}_wheel">
      <visual>
        <geometry><cylinder radius="0.04" length="0.035"/></geometry>
        <material name="yellow"/>
      </visual>
      <collision>
        <geometry><cylinder radius="0.04" length="0.035"/></geometry>
      </collision>
      <inertial>
        <mass value="0.4"/>
        <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
      </inertial>
    </link>
    <gazebo reference="${prefix}_wheel"><material>Gazebo/Yellow</material></gazebo>
  </xacro:macro>

  <xacro:wheel prefix="front_left"  x="0.08"  y="0.105"/>
  <xacro:wheel prefix="front_right" x="0.08"  y="-0.105"/>
  <xacro:wheel prefix="rear_left"   x="-0.08" y="0.105"/>
  <xacro:wheel prefix="rear_right"  x="-0.08" y="-0.105"/>

  <!-- 6. 마스트 (Mast) -->
  <joint name="mast_joint" type="fixed">
    <parent link="chassis"/>
    <child link="mast"/>
    <origin xyz="0.14 0 0.10"/>
  </joint>

  <link name="mast">
    <visual>
      <geometry><box size="0.015 0.04 0.20"/></geometry>
      <material name="silver"/>
    </visual>
    <collision>
      <geometry><box size="0.015 0.04 0.20"/></geometry>
    </collision>
    <inertial>
      <mass value="0.2"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
  </link>
  <gazebo reference="mast"><material>Gazebo/Grey</material></gazebo>

  <!-- 카메라 (Camera) -->
  <joint name="camera_joint" type="fixed">
    <parent link="mast"/>
    <child link="camera_link"/>
    <origin xyz="0.01 0 0.10"/>
  </joint>
  <link name="camera_link">
    <visual>
      <geometry><box size="0.02 0.04 0.02"/></geometry>
      <material name="black"/>
    </visual>
  </link>

  <!-- 7. 리프트 및 지게발 -->
  <joint name="lift_joint" type="prismatic">
    <parent link="mast"/>
    <child link="lift_plate"/>
    <origin xyz="0.02 0 -0.1"/>
    <axis xyz="0 0 1"/>
    <limit lower="0.0" upper="0.12" effort="500" velocity="0.2"/>
  </joint>

  <link name="lift_plate">
    <visual>
      <geometry><box size="0.01 0.10 0.06"/></geometry>
      <material name="black"/>
    </visual>
    <collision>
      <geometry><box size="0.01 0.10 0.06"/></geometry>
    </collision>
    <inertial>
      <mass value="0.1"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
  </link>

  <joint name="fork_left_joint" type="fixed">
    <parent link="lift_plate"/>
    <child link="fork_left"/>
    <origin xyz="0.08 0.035 -0.02"/>
  </joint>
  <link name="fork_left">
    <visual>
      <geometry><box size="0.16 0.015 0.005"/></geometry>
      <material name="red"/>
    </visual>
    <collision>
      <geometry><box size="0.16 0.015 0.005"/></geometry>
    </collision>
  </link>

  <joint name="fork_right_joint" type="fixed">
    <parent link="lift_plate"/>
    <child link="fork_right"/>
    <origin xyz="0.08 -0.035 -0.02"/>
  </joint>
  <link name="fork_right">
    <visual>
      <geometry><box size="0.16 0.015 0.005"/></geometry>
      <material name="red"/>
    </visual>
    <collision>
      <geometry><box size="0.16 0.015 0.005"/></geometry>
    </collision>
  </link>

  <!-- 9. [핵심 수정] 라이다 센서 (LiDAR) - ROS 2 Jazzy 호환 설정 -->
  <joint name="laser_joint" type="fixed">
    <parent link="white_box"/>
    <child link="laser_frame"/>
    <origin xyz="0 0 0.06" rpy="0 0 0"/>
  </joint>

  <link name="laser_frame">
    <visual>
      <geometry><cylinder radius="0.035" length="0.02"/></geometry>
      <material name="black"/>
    </visual>
    <collision>
      <geometry><cylinder radius="0.035" length="0.02"/></geometry>
    </collision>
    <inertial>
      <mass value="0.1"/>
      <inertia ixx="0.001" ixy="0" ixz="0" iyy="0.001" iyz="0" izz="0.001"/>
    </inertial>
  </link>

  <gazebo reference="laser_frame">
    <!-- Jazzy에서는 'ray' 대신 'gpu_lidar' 사용 권장 -->
    <sensor name="lidar" type="gpu_lidar">
      <pose>0 0 0 0 0 0</pose>
      <always_on>true</always_on>
      <visualize>true</visualize> <!-- 파란 레이저 보이기 -->
      <update_rate>10</update_rate>
      <topic>scan</topic> <!-- Gazebo 내부 토픽 이름 -->
      <ray>
        <scan>
          <horizontal>
            <samples>500</samples>
            <resolution>1</resolution>
            <min_angle>-3.14159</min_angle>
            <max_angle>3.14159</max_angle>
          </horizontal>
        </scan>
        <range>
          <min>0.12</min>
          <max>10.0</max>
          <resolution>0.015</resolution>
        </range>
        <noise>
          <type>gaussian</type>
          <mean>0.0</mean>
          <stddev>0.01</stddev>
        </noise>
      </ray>
    </sensor>
  </gazebo>


  <!-- [Jazzy 필수] 플러그인 로드 (Sensors & DiffDrive & JointState) -->
  <gazebo>
    <!-- 1. 센서 시스템 (이게 없으면 라이다가 작동 안함!) -->
    <plugin filename="gz-sim-sensors-system" name="gz::sim::systems::Sensors">
      <render_engine>ogre2</render_engine>
    </plugin>

    <!-- 2. 구동 시스템 (Diff Drive) -->
    <plugin filename="gz-sim-diff-drive-system" name="gz::sim::systems::DiffDrive">
      <!-- 시뮬레이션용으로 뒷바퀴만 구동 설정 (메카넘이지만 이동 테스트용) -->
      <left_joint>rear_left_wheel_joint</left_joint>
      <right_joint>rear_right_wheel_joint</right_joint>
      <wheel_separation>0.26</wheel_separation>
      <wheel_radius>0.04</wheel_radius>
      <odom_publish_frequency>20</odom_publish_frequency>
      <topic>cmd_vel</topic>
      <odom_topic>odom</odom_topic>
      <frame_id>odom</frame_id>
      <child_frame_id>base_link</child_frame_id>
    </plugin>

    <!-- 3. 관절 상태 퍼블리셔 (RViz에서 바퀴 굴러가는 것 보이게 함) -->
    <plugin filename="gz-sim-joint-state-publisher-system" name="gz::sim::systems::JointStatePublisher"/>
  </gazebo>

</robot>
```



### **3. 실습 결과**

위 코드를 실행하면(`ros2 launch my_bot spawn_robot.launch.py`) 아래 영상과 같은 결과가 나타납니다.

<video src="/images/2025-12-02-Gazebo를 이용한 ROS2 시뮬레이션/gazebo-sim-demo.webm" controls width="100%"></video>

1. **로봇 소환:** 텅 빈 Gazebo 환경 한가운데에 검은색 차체와 노란색 바퀴, 그리고 빨간색 지게발(Fork)을 가진 지게차 로봇이 나타납니다.
2. **센서 시각화:** 로봇 상단 라이다 센서 위치에서 파란색 레이저 빔(Ray)이 회전하며 주변을 스캔하는 모습이 시각화됩니다. 
3. **데이터 통신:** 터미널에서 ros2 topic list를 입력하면 /scan, /cmd_vel, /odom 토픽이 정상적으로 생성된 것을 확인할 수 있습니다.
4. **이동 테스트:** 별도의 터미널에서 `ros2 run teleop_twist_keyboard teleop_twist_keyboard`를 실행하여 키보드로 조종하면, 지게차가 앞뒤로 움직이고 회전하는 것을 볼 수 있습니다.



### **4. 마무리**

이번 시간에는 카메라 형상과 라이다 센서가 장착된 지게차 로봇 모델(URDF)을 작성하고, Gazebo 시뮬레이션 환경에 성공적(?)으로 띄워보았습니다.

다음 단계에서는 이 로봇 모델을 활용하여 **SLAM(지도 작성)**을 수행하거나 **Navigation2(자율주행)** 패키지를 연동하여, 로봇이 스스로 장애물을 피하고 목적지까지 화물을 운반하는 시뮬레이션을 진행해보겠습니다.
